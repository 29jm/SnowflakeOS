#include <stdint.h>
#include <string.h>
#include <stdio.h>
#include <stdlib.h>
#include <assert.h>

#include <kernel/term.h>
#include <kernel/multiboot.h>
#include <kernel/gdt.h>
#include <kernel/idt.h>
#include <kernel/irq.h>
#include <kernel/timer.h>
#include <kernel/pmm.h>
#include <kernel/paging.h>
#include <kernel/keyboard.h>
#include <kernel/syscall.h>
#include <kernel/proc.h>

extern uint32_t KERNEL_BEGIN_PHYS;
extern uint32_t KERNEL_END_PHYS;
extern uint32_t KERNEL_SIZE;

void kernel_main(multiboot* boot, uint32_t magic) {
	init_term();

	printf("\x1B[36mSnowflakeOS\x1B[37m 0.1 - Challenge Edition\n\n");
	printf("Kernel loaded at 0x%X, ending at 0x%X (%dKiB)\n",
		&KERNEL_BEGIN_PHYS, &KERNEL_END_PHYS, ((uint32_t) &KERNEL_SIZE) >> 10);

	assert(magic == MULTIBOOT_EAX_MAGIC);
	assert(boot->flags & MULTIBOOT_FLAG_MMAP);

	init_gdt();
	init_idt();
	init_isr();
	init_irq();
	init_timer();
	init_keyboard();
	init_pmm(boot);
	init_paging();
	init_syscall();

	uint8_t p1[] = {
		0xb9, 0x2a, 0x00, 0x00, 0x00, 0x51, 0x59, 0xeb, 0xf7
	};

	uint8_t p2[] = {
		0xb9, 0x45, 0x00, 0x00, 0x00, 0xeb, 0xf9, 0xb8, 0x01, 0x00, 0x00, 0x00,
		0xcd, 0x30
	};

	uint8_t p3[] = {
		0xb9, 0x39, 0x05, 0x00, 0x00, 0xb8, 0x03, 0x00, 0x00, 0x00, 0xbb, 0x48,
		0x00, 0x00, 0x00, 0xcd, 0x30, 0xbb, 0x65, 0x00, 0x00, 0x00, 0xcd, 0x30,
		0xbb, 0x6c, 0x00, 0x00, 0x00, 0xcd, 0x30, 0xbb, 0x6c, 0x00, 0x00, 0x00,
		0xcd, 0x30, 0xbb, 0x6f, 0x00, 0x00, 0x00, 0xcd, 0x30, 0xbb, 0x2c, 0x00,
		0x00, 0x00, 0xcd, 0x30, 0xbb, 0x20, 0x00, 0x00, 0x00, 0xcd, 0x30, 0xbb,
		0x77, 0x00, 0x00, 0x00, 0xcd, 0x30, 0xbb, 0x6f, 0x00, 0x00, 0x00, 0xcd,
		0x30, 0xbb, 0x72, 0x00, 0x00, 0x00, 0xcd, 0x30, 0xbb, 0x6c, 0x00, 0x00,
		0x00, 0xcd, 0x30, 0xbb, 0x64, 0x00, 0x00, 0x00, 0xcd, 0x30, 0xbb, 0x0a,
		0x00, 0x00, 0x00, 0xcd, 0x30, 0xb8, 0x02, 0x00, 0x00, 0x00, 0xbb, 0x0a,
		0x00, 0x00, 0x00, 0xcd, 0x30, 0xb8, 0x03, 0x00, 0x00, 0x00, 0xbb, 0x23,
		0x00, 0x00, 0x00, 0xcd, 0x30, 0xb8, 0x01, 0x00, 0x00, 0x00, 0xcd, 0x30
	};

	proc_run_code(p1, sizeof(p1));
	proc_run_code(p2, sizeof(p2));
	proc_run_code(p3, sizeof(p3));

	proc_print_processes();

	init_proc();
}
